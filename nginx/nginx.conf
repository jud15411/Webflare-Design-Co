# nginx/nginx.conf

# Define upstream services to give them easy-to-remember names.
# These names MUST match the service names in your docker-compose.yml file.

upstream backend_service {
    # This points to your Express.js server container.
    server server:5001;
}

upstream frontend_service {
    # This points to your Vite/React client container.
    server client:5173;
}

# The main server configuration block.
server {
    # Nginx will listen for traffic on port 80 inside the container.
    listen 80;

    # ==========================================================
    # Rule #1: API Traffic
    # Any request URL that starts with /api/ will match this block.
    # ==========================================================
    location /api/ {
        # Pass the request on to your backend Express.js service.
        # The URL is passed along as-is (e.g., /api/v1/users).
        proxy_pass http://backend_service;

        # Set standard proxy headers to pass along client information.
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ==========================================================
    # Rule #2: Frontend Application Traffic (Default)
    # Any request that does NOT match the rule above will fall here.
    # ==========================================================
    location / {
        # Pass the request on to your frontend Vite development server.
        proxy_pass http://frontend_service;

        # Set standard proxy headers.
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # IMPORTANT: These headers are required for Vite's Hot Module
        # Replacement (HMR) to work correctly through the proxy.
        # This allows for live updates in your browser during development.
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}